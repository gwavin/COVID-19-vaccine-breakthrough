---
title: "Censoring"
output: html_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE, warning= FALSE, message= FALSE}
# Preliminaries ----

## Import libraries
library(tidyverse)
library(lubridate)

## Output processed data to rds
dir.create(here::here("output", "markdown"), showWarnings = FALSE, recursive=TRUE)


## Custom function
tte <- function(origin_date, event_date, censor_date, na.censor=FALSE){
  # returns time-to-event date or time to censor date, which is earlier
  
  if (na.censor)
    time <- event_date-origin_date
  else
    time <- pmin(event_date-origin_date, censor_date-origin_date, na.rm=TRUE)
  as.numeric(time)
}

## Import data
data_extract0 <- read_csv(
  here::here("output", "data", "input.csv"),
  col_types = cols_only(
    
    covid_hospital_admission_date = col_date(format="%Y-%m-%d"),
    covid_death = col_logical(),
    dereg_date = col_date(format="%Y-%m-%d"),
    death_date = col_date(format="%Y-%m-%d"),
    age = col_integer(),
    covid_vax_2_date = col_date(format="%Y-%m-%d"),
    covid_vax_1_date = col_date(format="%Y-%m-%d")


    )) %>%
  mutate(
    
    # Censoring
    censor_date = pmin(death_date, 
                       dereg_date, 
                       as.Date(Sys.Date(), format = "%Y-%m-%d"), 
                       na.rm=TRUE),
    
    # Time since second dose
    follow_up_time_vax2 = tte(covid_vax_2_date,
                         as.Date(Sys.Date(), format = "%Y-%m-%d"),
                         censor_date),
    
    # Time since first dose
    follow_up_time_vax1 = tte(covid_vax_1_date,
                              as.Date(Sys.Date(), format = "%Y-%m-%d"),
                              censor_date))
```


## Dates coverage
```{r, echo = FALSE}
summary(data_extract0)
```

## Age and follow-up
```{r, echo = FALSE}
ggplot(data_extract0, aes(x = age)) +
  geom_histogram(binwidth = 5) +
  theme_bw() 

ggplot(data_extract0, aes(x = age, y = follow_up_time_vax1)) +
  geom_point() +
  theme_bw() 

ggplot(data_extract0, aes(x = age, y = follow_up_time_vax2)) +
  geom_point() +
  theme_bw() 
```
